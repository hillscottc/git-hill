-- =============================================
-- Author:		Valentin Kantchev
-- Create date: 05/20/2009
-- Description:	Inserts records in CTX.DataExploitation
-- =============================================
CREATE PROCEDURE CTX.[DataExploitationLoadInsert] 
AS
BEGIN
	insert into CTX.DataExploitation
	select 
		[ORGANIZATION_ID] = l.[ORGANIZATION_ID]
		,[CONTRACT_ID] = l.[CONTRACT_ID]
		,[RESTRICTIONS_CATEGORY] = l.[RESTRICTIONS_CATEGORY]
		,[RESTRICTIONS_ITEM] = l.[RESTRICTIONS_ITEM]
		,[RIGHT_ACQUIRED] = l.[RIGHT_ACQUIRED]
		,[TYPE_OF_RESTRICTION] = l.[TYPE_OF_RESTRICTION]
		,[WHEN_TO_CONSENT_CONSULT] = l.[WHEN_TO_CONSENT_CONSULT]
		,[PERIOD_OF_RESTRICTION] = l.[PERIOD_OF_RESTRICTION]
		,[RESTRICTION_END_DATE] = l.[RESTRICTION_END_DATE]
		,[DOWNLOAD_BY] = l.[DOWNLOAD_BY]
		,[COMPLETE_PRODUCT_ONLY] = l.[COMPLETE_PRODUCT_ONLY]
		,[HOLDBACKS] = l.[HOLDBACKS]
		,[NOTES] = l.[NOTES]
		,[ON_RESTRICTED_ARTIST_LIST] = l.[ON_RESTRICTED_ARTIST_LIST]
		,[RESTRICTED_ONLINE_MOBILE_USE] = l.[RESTRICTED_ONLINE_MOBILE_USE]
		,[RESTRICTED_MOBILE_AUDIO_USE] = l.[RESTRICTED_MOBILE_AUDIO_USE]
		,[RESTRICTED_MOBILE_VIDEO_USE] = l.[RESTRICTED_MOBILE_VIDEO_USE]
		,[RESTRICTED_ONLINE_AUDIO_USE] = l.[RESTRICTED_ONLINE_AUDIO_USE]
		,[RESTRICTED_ONLINE_VIDEO_USE] = l.[RESTRICTED_ONLINE_VIDEO_USE]

		,CHANGE_CODE = ld.CHANGE_CODE 
		,CHANGE_DATE_TIME = getdate()
		,WORKFLOW_CODE = 'L'
	from 
		CTX.LoadDataExploitation l 
		inner join CTX.LoadDataExploitationDriver ld 
			on l.CONTRACT_ID = ld.CONTRACT_ID 
				and l.RESTRICTIONS_CATEGORY = ld.RESTRICTIONS_CATEGORY
				and l.RESTRICTIONS_ITEM = ld.RESTRICTIONS_ITEM
	where 
		(ld.CHANGE_CODE = 'I' or ld.CHANGE_CODE = 'ID') and ld.[WORKFLOW_CODE] = 'T'
		and
		l.[WORKFLOW_CODE] = 'LT' 
		
	-- update row counts		
	exec CTX.TransformLogTaskInsert 'CTX.DataExploitation', @@rowcount, 'I'
		
END
