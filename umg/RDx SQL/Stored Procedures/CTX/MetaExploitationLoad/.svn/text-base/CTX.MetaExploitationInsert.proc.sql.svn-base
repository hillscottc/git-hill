-- =============================================
-- Author:		Valentin Kantchev
-- Create date: 05/20/2009
-- Description:	Inserts records in CTX.MetaExploitation
-- =============================================
CREATE PROCEDURE CTX.MetaExploitationInsert 
AS
BEGIN
	insert into CTX.MetaExploitation
	select 
		[ORGANIZATION_ID] = l.[ORGANIZATION_ID]
		,[TEMPLATE_ID] = l.[TEMPLATE_ID]
		,[TEMPLATE_NAME] = l.[TEMPLATE_NAME]
		,[RESTRICTIONS_CATEGORY] = l.[RESTRICTIONS_CATEGORY]
		,[RESTRICTIONS_ITEM] = l.[RESTRICTIONS_ITEM]
		
		,CHANGE_CODE = N'I' 
		,CHANGE_DATE_TIME = getdate()
		,WORKFLOW_CODE = 'L'
	from 
		CTX.MetaExploitation t
		right outer join CTX.LoadMetaExploitation l 
			on t.ORGANIZATION_ID = l.ORGANIZATION_ID 
				and t.TEMPLATE_ID = l.TEMPLATE_ID 
				and t.RESTRICTIONS_CATEGORY = l.RESTRICTIONS_CATEGORY
				and t.RESTRICTIONS_ITEM = l.RESTRICTIONS_ITEM
	where
		(t.ORGANIZATION_ID is null) 
		and (t.TEMPLATE_ID is null) 
		and (t.RESTRICTIONS_CATEGORY is null)
		and (t.RESTRICTIONS_ITEM is null)
		
		
	-- update row counts		
	exec CTX.TransformLogTaskInsert 'CTX.MetaExploitation', @@rowcount, 'I'
		
END
GO