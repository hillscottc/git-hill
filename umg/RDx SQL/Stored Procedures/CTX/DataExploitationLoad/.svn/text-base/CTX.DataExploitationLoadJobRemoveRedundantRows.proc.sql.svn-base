-- =============================================
-- Author:		Valentin Kantchev
-- Create date: 05/20/2009
-- Description:	Clears duplicate rows from CTX.LoadDataExploitation. 
-- =============================================
CREATE PROCEDURE CTX.[DataExploitationLoadJobRemoveRedundantRows] 
AS
BEGIN

	-- delete records with the same CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM and different change datetime.
	delete CTX.LoadDataExploitation
	from 
		CTX.LoadDataExploitation r
		inner join
		(
			-- finds duplicate CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM
			select CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM, MAX_CHANGE_DATE_TIME = max(CHANGE_DATE_TIME) 
			from CTX.LoadDataExploitation 
			where WORKFLOW_CODE = 'LT'
			group by CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM  having count(*) > 1
		) as t
		on r.CONTRACT_ID = t.CONTRACT_ID 
			and r.RESTRICTIONS_CATEGORY = t.RESTRICTIONS_CATEGORY
			and r.RESTRICTIONS_ITEM = t.RESTRICTIONS_ITEM
		where
			CHANGE_DATE_TIME <> t.MAX_CHANGE_DATE_TIME
			
	-- delete records with duplicate CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM 
	delete CTX.LoadDataExploitation
	from 
		CTX.LoadDataExploitation r
		inner join
		(
			-- finds duplicate CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM
			select CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM, MaxID = max(ID) 
			from CTX.LoadDataExploitation 
			where WORKFLOW_CODE = 'LT'
			group by CONTRACT_ID, RESTRICTIONS_CATEGORY, RESTRICTIONS_ITEM having count(*) > 1
		) as t
		on r.CONTRACT_ID = t.CONTRACT_ID 
			and r.RESTRICTIONS_CATEGORY = t.RESTRICTIONS_CATEGORY
			and r.RESTRICTIONS_ITEM = t.RESTRICTIONS_ITEM
		where
			ID <> t.MaxID			
			
END
GO