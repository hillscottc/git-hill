-- =============================================
-- Author:		Valentin Kantchev
-- Create date: 05/20/2009
-- Description:	Inserts records in CTX.LoadDataExploitationDriver
-- =============================================
CREATE PROCEDURE CTX.[DataExploitationLoadDriverLoad] 
AS
BEGIN
	declare @existingJobRows int
	set @existingJobRows = 0

	-- see if we have loaded records (i.e. rows with workflow_code = 'L')
	select @existingJobRows = count(*) from CTX.LoadDataExploitationDriver where WORKFLOW_CODE = 'L'
	if (@existingJobRows > 0)
		return @existingJobRows;
		
	declare @timestamp datetime
	set @timestamp = getdate()

	declare @rowcount int
	set @rowcount = 0
	
	-- New Records
	insert into CTX.LoadDataExploitationDriver 
	(
		CONTRACT_ID,
		RESTRICTIONS_CATEGORY,
		RESTRICTIONS_ITEM,
		WORKFLOW_CODE,
		CHANGE_CODE,
		CHANGE_DATE_TIME
	)
	select 
		l.CONTRACT_ID,
		l.RESTRICTIONS_CATEGORY,
		l.RESTRICTIONS_ITEM,
		'L',
		'I',
		@timestamp 
	from 
		CTX.LoadDataExploitation l
		left outer join CTX.DataExploitation t 
			on t.CONTRACT_ID = l.CONTRACT_ID 
				and t.RESTRICTIONS_CATEGORY = l.RESTRICTIONS_CATEGORY
				and t.RESTRICTIONS_ITEM = l.RESTRICTIONS_ITEM
	where 		
		(t.CONTRACT_ID is null) and (t.RESTRICTIONS_CATEGORY is null) and (t.RESTRICTIONS_ITEM is null)
		and
		l.WORKFLOW_CODE = 'LT'
		
	set @rowcount = @rowcount + @@rowcount

	-- Updates
	insert into CTX.LoadDataExploitationDriver 
	(
		CONTRACT_ID,
		RESTRICTIONS_CATEGORY,
		RESTRICTIONS_ITEM,
		WORKFLOW_CODE,
		CHANGE_CODE,
		CHANGE_DATE_TIME
	)
	select 
		l.CONTRACT_ID,
		l.RESTRICTIONS_CATEGORY,
		l.RESTRICTIONS_ITEM,
		'L',
		'U',
		@timestamp 
	from 
		CTX.LoadDataExploitation l
		inner join CTX.DataExploitation t 
			on l.CONTRACT_ID = t.CONTRACT_ID 
				and l.RESTRICTIONS_CATEGORY = t.RESTRICTIONS_CATEGORY
				and l.RESTRICTIONS_ITEM = t.RESTRICTIONS_ITEM
	where
		l.WORKFLOW_CODE = 'LT'	
		
	set @rowcount = @rowcount + @@rowcount						

	-- Deletes
	insert into CTX.LoadDataExploitationDriver 
	(
		CONTRACT_ID,
		RESTRICTIONS_CATEGORY,
		RESTRICTIONS_ITEM,
		WORKFLOW_CODE,
		CHANGE_CODE,
		CHANGE_DATE_TIME
	)
	select 
		t.CONTRACT_ID,
		t.RESTRICTIONS_CATEGORY,
		t.RESTRICTIONS_ITEM,
		'L',
		'UD',
		@timestamp 
	from 
		(
			-- this gets all records in LoadDataExploitation for CONTRACT_ID that also exist in DataExploitation
			select distinct t.CONTRACT_ID, t.RESTRICTIONS_CATEGORY, t.RESTRICTIONS_ITEM
			from 
				CTX.DataExploitation t 
				inner join CTX.LoadDataExploitation l
					on t.CONTRACT_ID = l.CONTRACT_ID
			where 
				l.WORKFLOW_CODE = 'LT'					
		)as t
		-- left join to LoadDataExploitation on all fields to see which records are not in LoadDataExploitation
		-- those records will have to be deleted from DataExploitation
		left outer join CTX.LoadDataExploitation l 
			on t.CONTRACT_ID = l.CONTRACT_ID 
				and t.RESTRICTIONS_CATEGORY = l.RESTRICTIONS_CATEGORY
				and t.RESTRICTIONS_ITEM = l.RESTRICTIONS_ITEM
	where
		(l.CONTRACT_ID is null) and (l.RESTRICTIONS_CATEGORY is null) and (l.RESTRICTIONS_ITEM is null)
		
	set @rowcount = @rowcount + @@rowcount		
	return @rowcount
	
END
GO